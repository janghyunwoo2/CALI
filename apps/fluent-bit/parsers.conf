# =====================================================
# Fluent Bit Parsers 설정
# =====================================================
# 설명: Regex 기반 로그 파싱 규칙 정의
# 핵심: Multiline 처리 + 헤더만 파싱
# =====================================================

[PARSER]
    Name   docker
    Format json
    Time_Key time
    Time_Format %Y-%m-%dT%H:%M:%S.%L
    Time_Keep On

# =====================================================
# Multiline Parser: 여러 줄 에러 로그의 시작 탐지
# =====================================================
# 목적: 스택 트레이스나 여러 줄 에러를 하나의 로그로 묶음
# 규칙: 타임스탬프나 로그 레벨로 시작하는 줄을 새 로그의 시작으로 인식
# =====================================================
[MULTILINE_PARSER]
    Name          multiline_start
    Type          regex
    Flush_timeout 1000
    # 정규식: 타임스탬프 또는 [레벨] 패턴으로 시작하는 줄을 로그의 시작으로 판단
    # 예시: "2026-01-19 14:00:01" 또는 "[ERROR]" 또는 "ERROR:"
    Rule      "start_state"   "/(^\d{4}-\d{2}-\d{2}|\[(?:ERROR|WARN|INFO|DEBUG|FATAL)\]|(?:ERROR|WARN|INFO|DEBUG|FATAL):)/"  "cont"
    Rule      "cont"          "/^(?!\d{4}-\d{2}-\d{2})(?!\[(?:ERROR|WARN|INFO|DEBUG|FATAL)\])/"  "cont"

# =====================================================
# 로그 헤더 파서: 시간, 레벨, 서비스명만 추출
# =====================================================
# 목적: 로그의 핵심 메타데이터만 파싱, 나머지는 원본 보존
# 출력: timestamp, level, service, message (전문)
# =====================================================
[PARSER]
    Name   log_header_parser
    Format regex
    # 정규식 패턴 설명:
    # - (?<timestamp>...) : 타임스탬프 추출 (예: 2026-01-19 14:00:01 또는 14:00:01)
    # - (?<level>...) : 로그 레벨 추출 (ERROR, WARN, INFO 등)
    # - (?<service>...) : 서비스명 추출 (예: payment-api)
    # - (?<message>.*) : 나머지 전체 메시지 (에러 전문, 스택 트레이스 포함)
    Regex  ^(?:\[)?(?<level>ERROR|WARN|WARNING|INFO|DEBUG|FATAL|CRITICAL)(?:\])?(?:\s+)?(?:(?<timestamp>\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+-]\d{2}:\d{2})?|\d{2}:\d{2}:\d{2}))?\s*(?:(?<service>[a-zA-Z0-9_-]+):?)?\s*(?<message>.*)$
    Time_Key timestamp
    Time_Format %Y-%m-%d %H:%M:%S
    Time_Keep On

# =====================================================
# 예시 로그 패턴 및 파싱 결과
# =====================================================
# 입력 예시 1:
#   [ERROR] 2026-01-19 14:00:01 payment-api: DB Connection timeout
#   at com.example.PaymentService.connect(PaymentService.java:42)
#   at com.example.Main.run(Main.java:15)
#
# 파싱 결과:
#   {
#     "timestamp": "2026-01-19 14:00:01",
#     "level": "ERROR",
#     "service": "payment-api",
#     "message": "DB Connection timeout\nat com.example.PaymentService.connect...",
#     "log_content": { ... } // 원본 전체 로그
#   }
#
# 입력 예시 2:
#   ERROR: OrderService failed to process order #12345
#   Stack trace:
#     File "order.py", line 89, in process_order
#
# 파싱 결과:
#   {
#     "level": "ERROR",
#     "service": "OrderService",
#     "message": "failed to process order #12345\nStack trace:\n  File...",
#     "log_content": { ... }
#   }
# =====================================================
