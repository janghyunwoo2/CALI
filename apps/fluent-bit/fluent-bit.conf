# =====================================================
# Fluent Bit 메인 설정 파일
# =====================================================
# 설명: 로그 수집, 파싱, 필터링, 출력 설정
# 출력: Kinesis Stream & Firehose (Multi-Output)
# 핵심: Multiline 처리로 여러 줄 에러를 하나로 묶음
# =====================================================

[SERVICE]
    # Fluent Bit 전역 설정
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

[INPUT]
    # Kubernetes 컨테이너 로그 수집
    Name              tail
    Path              /var/log/containers/*.log
    Parser            docker
    Tag               kube.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    # Multiline 설정: 여러 줄 에러 로그를 하나로 묶음
    Multiline         On
    Parser_Firstline  multiline_start

[FILTER]
    # Kubernetes 메타데이터 추가
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Keep_Log            Off

[FILTER]
    # 로그 헤더 파싱 (시간, 레벨, 서비스명)
    Name    parser
    Match   kube.*
    Key_Name log
    Parser  log_header_parser
    Reserve_Data On
    Preserve_Key On

[FILTER]
    # 원본 로그 전문을 log_content 필드에 보존
    Name    nest
    Match   kube.*
    Operation nest
    Wildcard log*
    Nest_under log_content
    Remove_prefix log

[FILTER]
    # JSON 구조화: 최종 출력 형식
    Name    modify
    Match   kube.*
    Add     collected_at ${FLUENT_BIT_TIMESTAMP}

[OUTPUT]
    # Kinesis Data Stream 출력 (Single Point of Entry)
    # Stream에서 자동으로 Firehose로 전달 (Terraform에서 설정)
    Name            kinesis_streams
    Match           kube.*
    region          ap-northeast-2
    stream          cali-log-stream
    # IRSA를 통한 IAM 인증 (ServiceAccount에 역할 연결됨)
    
# =====================================================
# Fan-out 아키텍처:
# Fluent Bit → Kinesis Stream (여기까지만!)
#   ↓
#   ├─→ Consumer (Lambda/ECS로 실시간 구독)
#   └─→ Kinesis Firehose (Stream에서 자동 전달)
#         ↓
#       OpenSearch & S3
# =====================================================
